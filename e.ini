<script>
  var mapContainer = document.getElementById('map');
  var map = new kakao.maps.Map(mapContainer, { 
    center: new kakao.maps.LatLng(37.5665, 126.9780), 
    level: 3
  });
  var currentMarker = null;
  var destinationMarker = null;
  var routePolyline = null;
  var destinationLatLng = null;
  var waypoints = []; // ì „ì—­ ì›¨ì´í¬ì¸íŠ¸ ë³€ìˆ˜
  var geocoder = new kakao.maps.services.Geocoder();
  var ws = null;

  // í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateLocation(lat, lon) {
    if (!lat || !lon) return;
    var locPosition = new kakao.maps.LatLng(lat, lon);
    console.log("ğŸ“ í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", lat, lon);
    if (currentMarker) {
      currentMarker.setPosition(locPosition);
    } else {
      currentMarker = new kakao.maps.Marker({
        position: locPosition,
        map: map,
        title: "í˜„ì¬ ìœ„ì¹˜"
      });
    }
    map.setCenter(locPosition);
    // ëª©ì ì§€ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´, ë¡œë´‡ ì œì–´ìš©ìœ¼ë¡œ í˜„ì¬ ìœ„ì¹˜ì™€ ì›¨ì´í¬ì¸íŠ¸ ì •ë³´ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // ì˜ˆ: ë¡œë´‡ ì œì–´ ì„œë²„ì— í˜„ì¬ ìœ„ì¹˜ì™€ í•¨ê»˜ 'waypoints' ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥.
  }

  // ì¹´ì¹´ì˜¤ ë„¤ë¹„ APIë¡œ ê²½ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í•œ ë²ˆë§Œ í˜¸ì¶œ)
  function getRouteData(startPos, endPos) {
    var url = 'https://apis-navi.kakaomobility.com/v1/directions';
    url += '?origin=' + startPos.getLng() + ',' + startPos.getLat();
    url += '&destination=' + endPos.getLng() + ',' + endPos.getLat();
    fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': 'KakaoAK 0a115b0069642fd0547386e225798817'
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log("ğŸ“ ê²½ë¡œ ë°ì´í„° ìˆ˜ì‹ :", data);
      if (!data.routes || data.routes.length === 0) {
        console.error("âŒ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      waypoints = [];  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      data.routes[0].sections[0].roads.forEach(function(road) {
        road.vertexes.forEach((coord, index) => {
          if (index % 2 === 0) {
            var lat = road.vertexes[index + 1];
            var lng = coord;
            waypoints.push(new kakao.maps.LatLng(lat, lng));
          }
        });
      });
      drawRoute(waypoints);
      // ì´ì œ 'waypoints' ë°°ì—´ì„ ë¡œë´‡ ì œì–´ ì•Œê³ ë¦¬ì¦˜ì— í™œìš©í•˜ê±°ë‚˜ ì„œë²„ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    })
    .catch(error => console.error("âŒ ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", error));
  }

  // í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
  function drawRoute(coords) {
    if (routePolyline) routePolyline.setMap(null);
    routePolyline = new kakao.maps.Polyline({
      path: coords,
      strokeWeight: 5,
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeStyle: 'solid'
    });
    routePolyline.setMap(map);
  }

  // ëª©ì ì§€ ê²€ìƒ‰: ì£¼ì†Œ ë³€í™˜ í›„ ê²½ë¡œ ìš”ì²­ (í•œ ë²ˆ í˜¸ì¶œ)
  function searchDestination() {
    var address = document.getElementById("destinationInput").value;
    if (!address) {
      alert("ëª©ì ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }
    geocoder.addressSearch(address, function(result, status) {
      if (status === kakao.maps.services.Status.OK) {
        destinationLatLng = new kakao.maps.LatLng(result[0].y, result[0].x);
        if (destinationMarker) destinationMarker.setMap(null);
        destinationMarker = new kakao.maps.Marker({ 
          position: destinationLatLng, 
          map: map, 
          title: "ëª©ì ì§€" 
        });
        if (currentMarker) {
          // í˜„ì¬ ìœ„ì¹˜ì™€ ëª©ì ì§€ê°€ ëª¨ë‘ ì •í•´ì¡Œìœ¼ë©´, ê²½ë¡œë¥¼ í•œ ë²ˆ ìš”ì²­
          getRouteData(currentMarker.getPosition(), destinationLatLng);
        }
      } else {
        alert("âŒ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨. ì •í™•í•œ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      }
    });
  }

  // WebSocket ì—°ê²° ë° GPS ë°ì´í„° ìˆ˜ì‹ 
  function connectWebSocket() {
    ws = new WebSocket("ws://localhost:8765");
    ws.onopen = function () {
      console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ!");
    };
    ws.onmessage = function (event) {
      try {
        var data = JSON.parse(event.data);
        if (data.latitude && data.longitude) {
          updateLocation(data.latitude, data.longitude);
        } else {
          console.warn("âš  GPS ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", data);
        }
      } catch (error) {
        console.error("âŒ GPS ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error);
      }
    };
    ws.onerror = function (error) {
      console.error("âŒ WebSocket ì˜¤ë¥˜:", error);
    };
    ws.onclose = function () {
      console.warn("âš  WebSocket ì—°ê²° ì¢…ë£Œë¨. 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...");
      setTimeout(connectWebSocket, 5000);
    };
  }
  connectWebSocket();
</script>
